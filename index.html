<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Field Payroll Pro - India</title>
    <style>
        :root {
            --primary: #0f172a; --accent: #2563eb; --success: #16a34a;
            --half: #f59e0b; --danger: #dc2626; --bg: #f8fafc;
        }
        body { font-family: 'Inter', system-ui, sans-serif; background: var(--bg); margin: 0; padding: 20px; display: flex; flex-direction: column; align-items: center; }
        .container { width: 100%; max-width: 1200px; }
        
        /* Header & Cards */
        .header-box { background: var(--primary); color: white; padding: 20px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 15px; margin-bottom: 15px; }
        .card { background: white; border-radius: 12px; padding: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); overflow-x: auto; border: 1px solid #e2e8f0; margin-bottom: 15px; }
        
        /* Table Styles */
        table { width: 100%; border-collapse: collapse; min-width: 1050px; }
        th { background: #f1f5f9; padding: 12px; font-size: 0.7rem; text-transform: uppercase; border-bottom: 2px solid #e2e8f0; color: #64748b; }
        td { padding: 10px; border-bottom: 1px solid #f1f5f9; text-align: center; }
        
        /* Grand Total Row Styling */
        .total-row { background: #f8fafc; border-top: 3px solid var(--primary); }
        .total-row td { font-weight: 800; font-size: 1.1rem; color: var(--primary); padding: 15px; }

        input, select { padding: 8px; border: 1px solid #cbd5e1; border-radius: 6px; font-size: 0.9rem; outline: none; }
        .name-input { width: 160px; font-weight: 600; color: var(--primary); }
        .num-input { width: 80px; font-weight: bold; }
        
        /* Attendance Colors */
        select[data-val="1"] { background: #dcfce7; color: var(--success); font-weight: bold; }
        select[data-val="0.5"] { background: #fef3c7; color: var(--half); font-weight: bold; }
        select[data-val="0"] { background: #fee2e2; color: var(--danger); }

        /* Buttons */
        .btn-group { display: flex; gap: 10px; flex-wrap: wrap; margin-top: 15px; }
        .btn { padding: 12px 20px; border-radius: 8px; border: none; font-weight: 600; cursor: pointer; display: flex; align-items: center; gap: 8px; color: white; transition: 0.2s; }
        .btn-add { background: var(--accent); }
        .btn-wa { background: #25D366; }
        .btn-save { background: var(--primary); }
        .btn-print { background: #64748b; }

        .search-box { width: 100%; padding: 12px; border-radius: 8px; border: 1px solid #ddd; margin-bottom: 12px; box-sizing: border-box; }
        .history-card { background: #fff; padding: 15px; border-radius: 10px; border: 1px solid #e2e8f0; margin-bottom: 8px; display: flex; justify-content: space-between; align-items: center; }
        .del-small { background: #fee2e2; color: var(--danger); border: none; padding: 6px 12px; border-radius: 6px; cursor: pointer; font-size: 0.8rem; font-weight: bold; }

        @media print { .btn, .no-print, .history-section, .btn-group, .search-box, .del-small { display: none !important; } .card { border: none; box-shadow: none; } }
    </style>
</head>
<body>

<div class="container">
    <div class="header-box">
        <div>
            <h1 style="margin:0; font-size: 1.5rem;">Field Payroll Tracker</h1>
            <input type="text" id="weekDate" style="background:rgba(255,255,255,0.1); border:1px solid rgba(255,255,255,0.2); color:white; padding:5px; border-radius:4px;" value="Jan 7 - Jan 14, 2026">
        </div>
        <div style="display:flex; gap:15px; align-items:center;">
            <span>Daily Rate: â‚¹</span>
            <input type="number" id="globalRate" value="500" class="num-input" oninput="updateAllRows()">
        </div>
    </div>

    <div class="card">
        <table id="attendanceTable">
            <thead>
                <tr>
                    <th style="text-align:left">Worker Name</th>
                    <th>M</th><th>T</th><th>W</th><th>T</th><th>F</th><th>S</th><th>S</th>
                    <th>Days</th>
                    <th>Advance</th>
                    <th>Final Payout</th>
                    <th class="no-print"></th>
                </tr>
            </thead>
            <tbody id="workerBody"></tbody>
            <tfoot>
                <tr class="total-row">
                    <td colspan="8" style="text-align:right">GRAND TOTAL:</td>
                    <td id="totalDaysSum">0</td>
                    <td>-</td>
                    <td id="grandTotalCell">â‚¹ 0</td>
                    <td class="no-print"></td>
                </tr>
            </tfoot>
        </table>

        <div class="btn-group">
            <button class="btn btn-add" onclick="addNewWorker()">+ Add Worker</button>
            <button class="btn btn-wa" onclick="shareWhatsApp()">WhatsApp Share</button>
            <button class="btn btn-save" onclick="archiveWeek()">Finish Week & Store</button>
            <button class="btn btn-print" onclick="window.print()">Download Receipt</button>
        </div>
    </div>

    <div class="card no-print">
        <h3 style="margin:0 0 10px 0">ðŸ“Œ Payment Notes (Pending / Details)</h3>
        <textarea id="notes" style="width:100%; height:70px; border:1px solid #ddd; border-radius:8px; padding:12px; font-family:inherit; resize: none;" oninput="saveCurrentState()" placeholder="Add any notes here..."></textarea>
    </div>

    <div class="history-section no-print" style="width:100%">
        <div style="display:flex; justify-content:space-between; align-items:center; margin-bottom: 10px;">
            <h3 style="margin:0">Work History</h3>
            <button class="del-small" onclick="clearAllHistory()">Delete All History</button>
        </div>
        <input type="text" id="historySearch" class="search-box" placeholder="ðŸ” Search records..." oninput="loadHistory()">
        <div id="historyList"></div>
    </div>
</div>

<script>
    function addNewWorker(name = "", days = [0,0,0,0,0,0,0], advance = 0) {
        const tbody = document.getElementById('workerBody');
        const row = document.createElement('tr');
        let dayCells = '';
        days.forEach((val) => {
            dayCells += `<td><select onchange="updateRow(this)" data-val="${val}">
                <option value="0" ${val==0?'selected':''}>A</option>
                <option value="1" ${val==1?'selected':''}>P</option>
                <option value="0.5" ${val==0.5?'selected':''}>H</option>
            </select></td>`;
        });
        row.innerHTML = `
            <td style="text-align:left"><input type="text" value="${name}" placeholder="Worker Name" class="name-input" oninput="saveCurrentState()"></td>
            ${dayCells}
            <td class="total-days">0</td>
            <td><input type="number" value="${advance}" class="num-input adv-input" oninput="updateRow(this)"></td>
            <td class="final-pay" style="font-weight:bold;">â‚¹ 0</td>
            <td class="no-print"><button class="del-small" onclick="removeRow(this)">âœ•</button></td>
        `;
        tbody.appendChild(row);
        updateRow(row.querySelector('select'));
    }

    function removeRow(btn) { 
        if(confirm("Remove worker?")) { 
            btn.closest('tr').remove(); 
            calculateTableTotals(); 
            saveCurrentState(); 
        } 
    }

    function updateRow(el) {
        const row = el.closest('tr');
        const rate = parseFloat(document.getElementById('globalRate').value) || 0;
        let days = 0;
        row.querySelectorAll('select').forEach(s => { 
            days += parseFloat(s.value); 
            s.setAttribute('data-val', s.value); 
        });
        const advance = parseFloat(row.querySelector('.adv-input').value) || 0;
        const totalPay = (days * rate) - advance;
        row.querySelector('.total-days').innerText = days;
        row.querySelector('.final-pay').innerText = "â‚¹ " + totalPay.toLocaleString('en-IN');
        calculateTableTotals();
        saveCurrentState();
    }

    function updateAllRows() { 
        document.querySelectorAll('#workerBody tr').forEach(row => updateRow(row.querySelector('select'))); 
    }

    function calculateTableTotals() {
        let grandTotal = 0;
        let totalDays = 0;
        document.querySelectorAll('.final-pay').forEach(cell => {
            grandTotal += parseFloat(cell.innerText.replace(/[â‚¹,]/g, '')) || 0;
        });
        document.querySelectorAll('.total-days').forEach(cell => {
            totalDays += parseFloat(cell.innerText) || 0;
        });
        document.getElementById('grandTotalCell').innerText = "â‚¹ " + grandTotal.toLocaleString('en-IN');
        document.getElementById('totalDaysSum').innerText = totalDays;
    }

    function saveCurrentState() {
        const data = { rate: document.getElementById('globalRate').value, notes: document.getElementById('notes').value, week: document.getElementById('weekDate').value, workers: [] };
        document.querySelectorAll('#workerBody tr').forEach(row => {
            let days = []; row.querySelectorAll('select').forEach(s => days.push(parseFloat(s.value)));
            data.workers.push({ name: row.querySelector('.name-input').value, days: days, advance: row.querySelector('.adv-input').value });
        });
        localStorage.setItem('field_active', JSON.stringify(data));
    }

    function archiveWeek() {
        if(!confirm(`Finish and Archive week?`)) return;
        const history = JSON.parse(localStorage.getItem('field_hist') || "[]");
        const currentData = JSON.parse(localStorage.getItem('field_active'));
        let totalVal = parseFloat(document.getElementById('grandTotalCell').innerText.replace(/[â‚¹,]/g,''));
        currentData.payout = totalVal;
        history.unshift(currentData);
        localStorage.setItem('field_hist', JSON.stringify(history));
        localStorage.removeItem('field_active');
        location.reload();
    }

    function loadHistory() {
        const history = JSON.parse(localStorage.getItem('field_hist') || "[]");
        const term = document.getElementById('historySearch').value.toLowerCase();
        const list = document.getElementById('historyList');
        list.innerHTML = history.filter(h => h.week.toLowerCase().includes(term)).map((h, i) => `
            <div class="history-card">
                <div style="cursor:pointer; flex:1" onclick="restoreWeek(${i})">
                    <strong style="color:var(--accent)">${h.week}</strong><br>
                    <small>${h.workers.length} Workers â€¢ â‚¹${h.payout.toLocaleString('en-IN')}</small>
                </div>
                <button class="del-small" onclick="deleteHistoryItem(${i})">Delete</button>
            </div>`).join('');
    }

    function restoreWeek(index) { if(confirm("Load old record? Current data will be replaced.")) { localStorage.setItem('field_active', JSON.stringify(JSON.parse(localStorage.getItem('field_hist'))[index])); location.reload(); } }
    function deleteHistoryItem(i) { if(confirm("Delete record?")) { let h = JSON.parse(localStorage.getItem('field_hist')); h.splice(i, 1); localStorage.setItem('field_hist', JSON.stringify(h)); loadHistory(); } }
    function clearAllHistory() { if(confirm("Delete ALL?")) { localStorage.removeItem('field_hist'); loadHistory(); } }

    function shareWhatsApp() {
        const rate = parseFloat(document.getElementById('globalRate').value) || 0;
        let text = `*Field Payroll Summary*\nðŸ“… *${document.getElementById('weekDate').value}*\nðŸ’° *Daily Rate: â‚¹${rate}*\n--------------------------\n\n`;
        let grandTotal = 0; let count = 0;
        document.querySelectorAll('#workerBody tr').forEach(row => {
            const name = row.querySelector('.name-input').value || "Worker";
            const days = parseFloat(row.querySelector('.total-days').innerText);
            const adv = parseFloat(row.querySelector('.adv-input').value) || 0;
            const final = (days * rate) - adv;
            if(days > 0) {
                text += `â–ªï¸ *${name}*\n`;
                text += adv > 0 ? `   (${days}d Ã— ${rate}) - Adv â‚¹${adv} = *â‚¹${final.toLocaleString('en-IN')}*\n\n` : `   ${days}d Ã— ${rate} = *â‚¹${final.toLocaleString('en-IN')}*\n\n`;
                grandTotal += final; count++;
            }
        });
        text += `--------------------------\nðŸ‘¥ *Workers:* ${count}\nðŸ’µ *NET PAYABLE: â‚¹${grandTotal.toLocaleString('en-IN')}*\n--------------------------\n`;
        const notes = document.getElementById('notes').value;
        if(notes) text += `\n*Notes:* ${notes}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`);
    }

    window.onload = () => {
        const saved = localStorage.getItem('field_active');
        if (saved) {
            const d = JSON.parse(saved);
            document.getElementById('globalRate').value = d.rate;
            document.getElementById('notes').value = d.notes;
            document.getElementById('weekDate').value = d.week;
            d.workers.forEach(w => addNewWorker(w.name, w.days, w.advance));
        } else { addNewWorker(); }
        loadHistory();
        calculateTableTotals();
    };
</script>
</body>
</html>
